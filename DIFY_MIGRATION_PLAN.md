# Dify 功能移植计划

本文档详细规划了将 Dify.ai 的核心功能移植到当前项目（SolidJS + Vike + Hono + Better Auth + Drizzle ORM）的分批次计划。

## Dify 核心功能分析

### 1. 工作流系统（Workflow）
- **可视化编辑器**：拖拽式节点编辑器，支持节点连接和配置
- **节点类型**：
  - LLM 节点（模型调用，支持流式）
  - 知识检索节点（从数据集查询，支持元数据过滤）
  - 工具节点（函数调用，内置和自定义工具）
  - 代码执行节点（Python/JavaScript 隔离执行）
  - 条件判断节点（if/else 分支逻辑）
  - 迭代节点（数组循环执行）
  - 问题分类节点（意图分类路由）
  - 参数提取节点（从输入提取结构化数据）
  - HTTP 请求节点（外部 API 调用）
  - 模板转换节点（Jinja2 模板渲染）
- **工作流执行引擎**：解析、验证、执行、状态追踪
- **工作流管理**：创建、编辑、版本控制、导入/导出

### 2. 聊天系统（Chat）
- **基础聊天**：消息发送、接收、历史记录
- **增强功能**：
  - 对话开场白（AI 主动发送欢迎消息）
  - 后续建议（自动生成后续问题建议）
  - 文本转语音（TTS）
  - 文件上传（文档、图片、音频、视频）
  - 引用和归属（显示参考来源）
  - 内容审核（敏感内容过滤）
- **流式响应**：实时显示 AI 生成内容
- **多模态支持**：文本、图片、音频、视频

### 3. 知识库系统（Knowledge Base）
- **文档管理**：上传、编辑、删除文档
- **文档分段**：自动或手动分段
- **向量检索**：基于嵌入模型的语义搜索
- **元数据过滤**：支持元数据字段过滤
- **动态知识库选择**：运行时选择多个数据集
- **检索测试**：模拟查询测试检索效果

### 4. 数据集管理（Dataset）
- **数据集创建**：创建多个知识库
- **内容管理**：添加、修改、删除文档和分段
- **索引配置**：调整索引方法、嵌入模型、检索策略
- **元数据增强**：为文档添加元数据
- **检索验证**：测试检索效果

## 移植批次规划

### 第一批次：增强聊天系统 ⏳
**目标**：将基础聊天功能升级为 Dify 级别的增强聊天系统

**任务清单**：
- [ ] 1.1 扩展聊天消息 Schema（支持文件附件、引用、元数据）
- [ ] 1.2 实现文件上传功能（文档、图片、音频、视频）
- [ ] 1.3 实现流式响应（使用 TanStack AI 的流式 API）
- [ ] 1.4 添加对话开场白功能
- [ ] 1.5 实现后续建议功能（基于上下文生成建议问题）
- [ ] 1.6 添加消息引用和归属显示
- [ ] 1.7 实现内容审核（可选，集成审核 API）
- [ ] 1.8 优化聊天 UI（更好的消息展示、文件预览、引用卡片）

**预计工作量**：3-5 天

---

### 第二批次：工作流节点扩展 🚧
**目标**：扩展工作流编辑器，支持 Dify 的核心节点类型

**任务清单**：
- [ ] 2.1 设计工作流 Schema（节点、边、配置的数据库结构）
- [ ] 2.2 实现工作流 CRUD API
- [ ] 2.3 扩展工作流编辑器 UI（节点面板、配置面板）
- [ ] 2.4 实现 LLM 节点（集成 TanStack AI）
- [ ] 2.5 实现条件判断节点（if/else）
- [ ] 2.6 实现 HTTP 请求节点
- [ ] 2.7 实现代码执行节点（Python/JavaScript）
- [ ] 2.8 实现参数提取节点
- [ ] 2.9 实现模板转换节点（Jinja2）
- [ ] 2.10 工作流验证和预览功能

**预计工作量**：5-7 天

---

### 第三批次：工作流执行引擎 🔨
**目标**：实现工作流的解析、验证和执行引擎

**任务清单**：
- [ ] 3.1 工作流解析器（将 JSON 配置解析为执行图）
- [ ] 3.2 工作流验证器（检查节点配置、连接有效性）
- [ ] 3.3 节点执行调度器（按依赖顺序执行节点）
- [ ] 3.4 异步任务队列（使用 Hono 的队列或外部队列）
- [ ] 3.5 执行状态追踪（实时更新执行状态）
- [ ] 3.6 错误处理和重试机制
- [ ] 3.7 工作流执行历史记录
- [ ] 3.8 执行监控面板（显示执行进度、日志）

**预计工作量**：5-7 天

---

### 第四批次：知识库系统 📚
**目标**：实现完整的知识库管理功能

**任务清单**：
- [ ] 4.1 设计知识库 Schema（知识库、文档、分段、元数据）
- [ ] 4.2 实现文档上传和解析（支持多种格式：PDF、DOCX、TXT、MD）
- [ ] 4.3 实现文档分段（自动分段和手动分段）
- [ ] 4.4 集成向量数据库（使用 pgvector 或外部向量数据库）
- [ ] 4.5 实现嵌入模型集成（OpenAI、本地模型等）
- [ ] 4.6 实现语义检索 API（基于向量相似度）
- [ ] 4.7 实现元数据过滤功能
- [ ] 4.8 实现知识库管理 UI（列表、详情、编辑）
- [ ] 4.9 实现文档管理 UI（上传、预览、编辑、删除）
- [ ] 4.10 实现检索测试界面

**预计工作量**：7-10 天

---

### 第五批次：知识检索节点集成 🔗
**目标**：将知识库检索功能集成到工作流中

**任务清单**：
- [ ] 5.1 实现知识检索节点（在工作流中调用知识库）
- [ ] 5.2 支持动态知识库选择（运行时选择）
- [ ] 5.3 支持元数据过滤配置（在节点中配置过滤条件）
- [ ] 5.4 实现检索结果格式化（将检索结果传递给下游节点）
- [ ] 5.5 优化检索性能（缓存、批量检索）

**预计工作量**：3-5 天

---

### 第六批次：工具节点和代码执行 🔧
**目标**：实现工具调用和代码执行能力

**任务清单**：
- [ ] 6.1 设计工具系统架构（工具注册、调用、结果处理）
- [ ] 6.2 实现内置工具库（HTTP 请求、数据库查询、文件操作等）
- [ ] 6.3 实现自定义工具开发框架（允许用户定义工具）
- [ ] 6.4 实现工具节点（在工作流中调用工具）
- [ ] 6.5 实现代码执行节点（Python/JavaScript 沙箱执行）
- [ ] 6.6 实现代码执行安全隔离（使用 Docker 或 WebAssembly）
- [ ] 6.7 工具和代码执行结果处理

**预计工作量**：7-10 天

---

### 第七批次：高级工作流功能 🚀
**目标**：实现迭代节点、问题分类等高级功能

**任务清单**：
- [ ] 7.1 实现迭代节点（数组循环执行）
- [ ] 7.2 实现问题分类节点（意图分类，路由到不同分支）
- [ ] 7.3 实现子工作流调用（工作流嵌套）
- [ ] 7.4 实现并行执行支持（多个节点并行执行）
- [ ] 7.5 实现工作流模板系统（预定义模板）
- [ ] 7.6 实现工作流版本管理（版本控制、回滚）

**预计工作量**：5-7 天

---

### 第八批次：优化和增强 ✨
**目标**：优化性能、增强用户体验

**任务清单**：
- [ ] 8.1 工作流执行性能优化（缓存、并行化）
- [ ] 8.2 知识库检索性能优化（索引优化、批量处理）
- [ ] 8.3 UI/UX 优化（更好的交互、动画、反馈）
- [ ] 8.4 实现工作流分享和发布功能
- [ ] 8.5 实现使用统计和分析
- [ ] 8.6 实现监控和告警系统
- [ ] 8.7 完善错误处理和用户提示

**预计工作量**：5-7 天

---

## 技术实现要点

### 1. 数据库 Schema 设计
- **工作流表**：存储工作流定义、配置、版本
- **工作流执行表**：存储执行历史、状态、结果
- **知识库表**：存储知识库元数据
- **文档表**：存储文档信息、元数据
- **文档分段表**：存储分段内容、向量嵌入、元数据
- **消息扩展表**：存储消息附件、引用、元数据

### 2. API 设计
- **工作流 API**：`/api/workflows/*`
- **工作流执行 API**：`/api/workflows/:id/run`
- **知识库 API**：`/api/knowledge-bases/*`
- **文档 API**：`/api/documents/*`
- **检索 API**：`/api/retrieval/*`
- **文件上传 API**：`/api/upload/*`

### 3. 前端组件设计
- **工作流编辑器组件**：基于 `@dschz/solid-flow` 扩展
- **节点配置面板**：动态表单，根据节点类型渲染
- **知识库管理组件**：列表、详情、编辑器
- **文档管理组件**：上传、预览、编辑
- **聊天增强组件**：文件上传、引用显示、建议生成

### 4. 执行引擎设计
- **工作流解析器**：将 JSON 配置解析为有向无环图（DAG）
- **节点执行器**：根据节点类型调用相应的执行函数
- **状态管理器**：追踪每个节点的执行状态和结果
- **错误处理器**：捕获、记录、重试错误

## 注意事项

1. **性能考虑**：
   - 工作流执行使用异步队列，避免阻塞
   - 向量检索使用索引优化
   - 流式响应使用 Server-Sent Events 或 WebSocket

2. **安全性**：
   - 代码执行必须在沙箱环境中
   - 文件上传需要类型和大小限制
   - API 调用需要认证和权限控制

3. **可扩展性**：
   - 节点类型使用插件化设计
   - 工具系统支持动态注册
   - 知识库支持多种向量数据库后端

4. **用户体验**：
   - 实时反馈执行状态
   - 清晰的错误提示
   - 直观的可视化界面

## 进度追踪

- [ ] 第一批次：增强聊天系统
- [ ] 第二批次：工作流节点扩展
- [ ] 第三批次：工作流执行引擎
- [ ] 第四批次：知识库系统
- [ ] 第五批次：知识检索节点集成
- [ ] 第六批次：工具节点和代码执行
- [ ] 第七批次：高级工作流功能
- [ ] 第八批次：优化和增强

---

**最后更新**：2025-01-27
**当前批次**：第一批次 - 增强聊天系统
